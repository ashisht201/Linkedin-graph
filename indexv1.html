<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Graph</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #080c12; --panel: #0d1520; --border: #1a2a3a;
    --accent: #00e5ff; --accent2: #ff6b35; --accent3: #7fff6b;
    --text: #c8d8e8; --text-dim: #4a6a8a;
  }
  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border); background: var(--panel); flex-shrink: 0; z-index: 10; }
  header h1 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.1rem; letter-spacing: 0.08em; color: #fff; }
  header h1 span { color: var(--accent); }
  .stats { display: flex; gap: 24px; font-size: 0.7rem; color: var(--text-dim); }
  .stats b { color: var(--accent); font-weight: 500; }
  .load-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); font-family: 'DM Mono', monospace; font-size: 0.7rem; padding: 6px 14px; cursor: pointer; letter-spacing: 0.1em; transition: all 0.2s; }
  .load-btn:hover { background: var(--accent); color: var(--bg); }
  .main { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 220px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
  .sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
  .sidebar-section h3 { font-size: 0.6rem; letter-spacing: 0.2em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; }
  .control-row { margin-bottom: 12px; }
  .control-row label { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-dim); margin-bottom: 5px; }
  .control-row label span { color: var(--text); }
  input[type=range] { width: 100%; -webkit-appearance: none; height: 2px; background: var(--border); outline: none; border-radius: 2px; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
  .search-box { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.7rem; padding: 7px 10px; outline: none; transition: border-color 0.2s; }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--text-dim); }
  .company-list { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
  .company-item { display: flex; align-items: center; gap: 8px; font-size: 0.65rem; cursor: pointer; color: var(--text-dim); transition: color 0.15s; }
  .company-item:hover { color: var(--text); }
  .company-item.active { color: var(--text); }
  .company-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .canvas-wrap { flex: 1; position: relative; overflow: hidden; }
  canvas { width: 100%; height: 100%; cursor: grab; display: block; }
  canvas.grabbing { cursor: grabbing; }
  .info-panel { position: absolute; bottom: 20px; right: 20px; width: 260px; background: var(--panel); border: 1px solid var(--border); padding: 16px; display: none; z-index: 5; }
  .info-panel.visible { display: block; }
  .info-panel h2 { font-family: 'Syne', sans-serif; font-size: 0.95rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .info-panel .role { font-size: 0.65rem; color: var(--text-dim); margin-bottom: 12px; }
  .info-panel .companies { font-size: 0.65rem; color: var(--text-dim); line-height: 1.8; }
  .info-panel .companies b { color: var(--text); font-weight: 400; }
  .info-close { position: absolute; top: 10px; right: 12px; background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 0.8rem; }
  .info-close:hover { color: var(--text); }
  .tooltip { position: absolute; background: var(--panel); border: 1px solid var(--border); padding: 6px 10px; font-size: 0.65rem; color: var(--accent); pointer-events: none; display: none; z-index: 10; white-space: nowrap; }
  .mock-notice { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background: rgba(255,107,53,0.1); border: 1px solid var(--accent2); color: var(--accent2); font-size: 0.6rem; padding: 5px 14px; letter-spacing: 0.1em; pointer-events: none; }
  .loading-overlay { position: absolute; inset: 0; background: rgba(8,12,18,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; gap: 16px; }
  .loading-overlay.hidden { display: none; }
  .loading-bar-wrap { width: 240px; height: 2px; background: var(--border); }
  .loading-bar { height: 100%; background: var(--accent); transition: width 0.3s; width: 0%; }
  .loading-text { font-size: 0.7rem; color: var(--text-dim); letter-spacing: 0.15em; }
  #fileInput { display: none; }
</style>
</head>
<body>

<header>
  <h1>NET<span>WORK</span></h1>
  <div class="stats">
    <div><b id="stat-nodes">0</b> connections</div>
    <div><b id="stat-edges">0</b> links</div>
    <div><b id="stat-companies">0</b> companies</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button class="load-btn" onclick="document.getElementById('fileInput').click()">LOAD DATA</button>
    <input type="file" id="fileInput" accept=".json" onchange="loadFile(event)">
  </div>
</header>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Search</h3>
      <input type="text" class="search-box" placeholder="name or company..." oninput="searchGraph(this.value)">
    </div>
    <div class="sidebar-section">
      <h3>Physics</h3>
      <div class="control-row">
        <label>Repulsion <span id="val-charge">-120</span></label>
        <input type="range" min="-600" max="-20" value="-120" oninput="updateForce('charge',this.value);document.getElementById('val-charge').textContent=this.value">
      </div>
      <div class="control-row">
        <label>Link distance <span id="val-dist">60</span></label>
        <input type="range" min="10" max="300" value="60" oninput="updateForce('distance',this.value);document.getElementById('val-dist').textContent=this.value">
      </div>
      <div class="control-row">
        <label>Link strength <span id="val-strength">0.5</span></label>
        <input type="range" min="0.01" max="2" step="0.01" value="0.5" oninput="updateForce('strength',this.value);document.getElementById('val-strength').textContent=parseFloat(this.value).toFixed(2)">
      </div>
    </div>
    <div class="sidebar-section">
      <h3>Top companies <span style="color:var(--text-dim);font-size:0.55rem">(click to highlight)</span></h3>
      <div class="company-list" id="company-list"></div>
    </div>
    <div class="sidebar-section">
      <h3>Min connections</h3>
      <div class="control-row">
        <label>Show nodes with ≥ <span id="val-mindeg">1</span> links</label>
        <input type="range" min="1" max="20" value="1" oninput="updateMinDegree(+this.value)">
      </div>
    </div>
  </div>

  <div class="canvas-wrap" id="canvas-wrap">
    <div class="mock-notice" id="mock-notice">⚠ MOCK DATA — Load your own JSON to visualize your network</div>
    <canvas id="graph"></canvas>
    <div class="loading-overlay hidden" id="loading-overlay">
      <div class="loading-text" id="loading-text">BUILDING GRAPH...</div>
      <div class="loading-bar-wrap"><div class="loading-bar" id="loading-bar"></div></div>
    </div>
    <div class="info-panel" id="info-panel">
      <button class="info-close" onclick="closeInfo()">✕</button>
      <h2 id="info-name"></h2>
      <div class="role" id="info-role"></div>
      <div class="companies" id="info-companies"></div>
      <a id="info-link" href="#" target="_blank" style="font-size:0.6rem;color:var(--accent);display:block;margin-top:10px">View on LinkedIn ↗</a>
    </div>
    <div class="tooltip" id="tooltip"></div>
  </div>
</div>

<script>
// ─── CONSTANTS ────────────────────────────────────────────────────────────────
const PALETTE = [
  "#00e5ff","#ff6b35","#7fff6b","#ff4fd8","#ffd700",
  "#a78bfa","#34d399","#f87171","#60a5fa","#fb923c",
  "#e879f9","#4ade80","#38bdf8","#facc15","#f472b6",
  "#818cf8","#2dd4bf","#fb7185","#a3e635","#c084fc"
];

const MAX_EDGES_PER_NODE = 8;   // cap edges per node to avoid hairball
const MAX_TOTAL_EDGES = 15000;  // hard cap on total edges rendered

// ─── MOCK DATA ────────────────────────────────────────────────────────────────
const MOCK_DATA = {
  nodes: [
    { id:"1",  name:"Alice Chen",    companies:["Google","Stripe","MIT Lab"] },
    { id:"2",  name:"Ben Okafor",    companies:["Stripe","PayPal","YC"] },
    { id:"3",  name:"Clara Voss",    companies:["Google","DeepMind","MIT Lab"] },
    { id:"4",  name:"David Kim",     companies:["DeepMind","Google","OpenAI"] },
    { id:"5",  name:"Eva Martins",   companies:["OpenAI","Anthropic","MIT Lab"] },
    { id:"6",  name:"Frank Liu",     companies:["Anthropic","OpenAI","Google"] },
    { id:"7",  name:"Gina Park",     companies:["Meta","Instagram","Google"] },
    { id:"8",  name:"Hassan Ali",    companies:["Meta","WhatsApp","YC"] },
    { id:"9",  name:"Iris Novak",    companies:["Stripe","Brex","YC"] },
    { id:"10", name:"James Torres",  companies:["Brex","Stripe","PayPal"] },
    { id:"11", name:"Keiko Sato",    companies:["PayPal","Stripe","Visa"] },
    { id:"12", name:"Leo Ferreira",  companies:["Visa","PayPal","Mastercard"] },
    { id:"13", name:"Maya Patel",    companies:["Mastercard","Visa","Goldman"] },
    { id:"14", name:"Noah Williams", companies:["Goldman","JPMorgan","Mastercard"] },
    { id:"15", name:"Olivia Scott",  companies:["JPMorgan","Goldman","Citi"] },
    { id:"16", name:"Pedro Costa",   companies:["Citi","JPMorgan","HSBC"] },
    { id:"17", name:"Quinn Harper",  companies:["HSBC","Citi","Barclays"] },
    { id:"18", name:"Rachel Moore",  companies:["Barclays","HSBC","Goldman"] },
    { id:"19", name:"Sam Nguyen",    companies:["YC","Airbnb","Stripe"] },
    { id:"20", name:"Tara Singh",    companies:["Airbnb","Uber","YC"] },
    { id:"21", name:"Uma Krishnan",  companies:["Uber","Lyft","Airbnb"] },
    { id:"22", name:"Victor Blanc",  companies:["Lyft","Uber","DoorDash"] },
    { id:"23", name:"Wendy Zhang",   companies:["DoorDash","Lyft","Instacart"] },
    { id:"24", name:"Xander Brown",  companies:["Instacart","DoorDash","Amazon"] },
    { id:"25", name:"Yuki Tanaka",   companies:["Amazon","AWS","Microsoft"] },
    { id:"26", name:"Zara Ahmed",    companies:["Microsoft","Amazon","LinkedIn"] },
    { id:"27", name:"Adam Foster",   companies:["LinkedIn","Microsoft","Google"] },
    { id:"28", name:"Beth Holland",  companies:["AWS","Amazon","Google"] },
    { id:"29", name:"Carlos Reyes",  companies:["OpenAI","Google","DeepMind"] },
    { id:"30", name:"Dana White",    companies:["Anthropic","MIT Lab","OpenAI"] },
  ]
};

// ─── STATE ────────────────────────────────────────────────────────────────────
let graphData = null;
let simulation = null;
let companyColors = {};
let highlightedCompany = null;
let searchMatches = null;
let hoveredNode = null;
let minDegree = 1;
let currentCharge = -120, currentDistance = 60, currentStrength = 0.5;

// Canvas state
let canvas, ctx, W, H;
let transform = { x: 0, y: 0, k: 1 };
let isPanning = false, panStart = null;

// ─── FAST EDGE BUILDER ────────────────────────────────────────────────────────
// Uses inverted index: company -> [nodes] instead of O(n²) comparison
function buildEdges(nodes) {
  // Build company -> node index
  const companyIndex = {};
  nodes.forEach(n => {
    n.companies.forEach(c => {
      if (!companyIndex[c]) companyIndex[c] = [];
      companyIndex[c].push(n.id);
    });
  });

  // Build edges using index — O(n * avg_companies) instead of O(n²)
  const edgeMap = {};
  const edgeCount = {};  // track per-node edge count for capping

  nodes.forEach(n => {
    edgeCount[n.id] = 0;
  });

  nodes.forEach(n => {
    n.companies.forEach(company => {
      const peers = companyIndex[company];
      if (!peers) return;
      for (const peerId of peers) {
        if (peerId === n.id) continue;
        if ((edgeCount[n.id] || 0) >= MAX_EDGES_PER_NODE) continue;
        if ((edgeCount[peerId] || 0) >= MAX_EDGES_PER_NODE) continue;

        const key = n.id < peerId ? `${n.id}||${peerId}` : `${peerId}||${n.id}`;
        if (edgeMap[key]) {
          if (!edgeMap[key].companies.includes(company)) edgeMap[key].companies.push(company);
        } else {
          edgeMap[key] = { source: n.id, target: peerId, companies: [company] };
          edgeCount[n.id] = (edgeCount[n.id] || 0) + 1;
          edgeCount[peerId] = (edgeCount[peerId] || 0) + 1;
        }

        if (Object.keys(edgeMap).length >= MAX_TOTAL_EDGES) return;
      }
    });
  });

  return Object.values(edgeMap).map(e => ({ ...e, weight: e.companies.length }));
}

// ─── INIT ─────────────────────────────────────────────────────────────────────
function showLoading(text, pct) {
  const el = document.getElementById('loading-overlay');
  el.classList.remove('hidden');
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-bar').style.width = pct + '%';
}
function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }

function init(data) {
  showLoading('PROCESSING NODES...', 10);

  // Use setTimeout to let the loading UI paint before heavy work
  setTimeout(() => {
    const nodes = data.nodes.map(d => ({ ...d }));

    showLoading('BUILDING CONNECTIONS...', 30);
    setTimeout(() => {
      const edges = buildEdges(nodes);

      // Assign colors to top companies by frequency
      const freq = {};
      nodes.forEach(n => n.companies.forEach(c => freq[c] = (freq[c] || 0) + 1));
      const topCompanies = Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0, 40).map(e => e[0]);
      topCompanies.forEach((c, i) => companyColors[c] = PALETTE[i % PALETTE.length]);

      // Degree map
      const degreeMap = {};
      nodes.forEach(n => degreeMap[n.id] = 0);
      edges.forEach(e => { degreeMap[e.source]++; degreeMap[e.target]++; });
      nodes.forEach(n => n._degree = degreeMap[n.id] || 0);

      // Node id -> node map
      const nodeMap = {};
      nodes.forEach(n => nodeMap[n.id] = n);

      graphData = { nodes, edges, nodeMap, degreeMap };

      // Stats
      document.getElementById('stat-nodes').textContent = nodes.length;
      document.getElementById('stat-edges').textContent = edges.length;
      document.getElementById('stat-companies').textContent = topCompanies.length;

      // Company filter list (top 20 by frequency)
      const list = document.getElementById('company-list');
      list.innerHTML = '';
      topCompanies.slice(0, 20).forEach(c => {
        const count = freq[c];
        const color = companyColors[c] || '#888';
        const item = document.createElement('div');
        item.className = 'company-item active';
        item.dataset.company = c;
        item.innerHTML = `<div class="company-dot" style="background:${color}"></div><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c}</span><span style="color:var(--accent);margin-left:4px">${count}</span>`;
        item.onclick = () => toggleCompanyHighlight(c, item);
        list.appendChild(item);
      });

      showLoading('STARTING SIMULATION...', 60);
      setTimeout(() => {
        setupCanvas();
        runSimulation(nodes, edges);
      }, 50);
    }, 50);
  }, 50);
}

// ─── CANVAS SETUP ─────────────────────────────────────────────────────────────
function setupCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  canvas = document.getElementById('graph');
  W = wrap.clientWidth;
  H = wrap.clientHeight;
  canvas.width = W;
  canvas.height = H;
  ctx = canvas.getContext('2d');

  // Center transform
  transform = { x: W / 2, y: H / 2, k: 1 };

  // Mouse events
  canvas.addEventListener('mousedown', onMouseDown);
  canvas.addEventListener('mousemove', onMouseMove);
  canvas.addEventListener('mouseup', onMouseUp);
  canvas.addEventListener('wheel', onWheel, { passive: false });
  canvas.addEventListener('click', onCanvasClick);

  window.addEventListener('resize', onResize);
}

function onResize() {
  const wrap = document.getElementById('canvas-wrap');
  W = wrap.clientWidth;
  H = wrap.clientHeight;
  canvas.width = W;
  canvas.height = H;
  draw();
}

// ─── SIMULATION ───────────────────────────────────────────────────────────────
function runSimulation(nodes, edges) {
  if (simulation) simulation.stop();

  simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(d => d.id).distance(currentDistance).strength(currentStrength))
    .force('charge', d3.forceManyBody().strength(currentCharge).distanceMax(300))
    .force('center', d3.forceCenter(0, 0))
    .force('collide', d3.forceCollide(12))
    .alphaDecay(0.03)
    .on('tick', () => {
      draw();
    })
    .on('end', () => {
      hideLoading();
      draw();
    });

  // Update loading bar during simulation warmup
  let ticks = 0;
  const origTick = simulation.on('tick');
  simulation.on('tick', () => {
    ticks++;
    if (ticks < 100) {
      showLoading('SIMULATING PHYSICS...', 60 + ticks * 0.4);
    } else {
      hideLoading();
    }
    draw();
  });
}

// ─── DRAW ─────────────────────────────────────────────────────────────────────
function draw() {
  if (!ctx || !graphData) return;
  ctx.clearRect(0, 0, W, H);

  ctx.save();
  ctx.translate(transform.x, transform.y);
  ctx.scale(transform.k, transform.k);

  const nodes = graphData.nodes;
  const edges = graphData.edges;

  const activeNodes = minDegree > 1
    ? new Set(nodes.filter(n => n._degree >= minDegree).map(n => n.id))
    : null;

  // Draw edges
  ctx.globalAlpha = highlightedCompany || searchMatches ? 0.04 : 0.18;
  edges.forEach(e => {
    const s = e.source, t = e.target;
    if (!s.x || !t.x) return;
    if (activeNodes && (!activeNodes.has(s.id) || !activeNodes.has(t.id))) return;

    const isHighlighted = highlightedCompany
      ? e.companies.includes(highlightedCompany)
      : searchMatches
        ? (searchMatches.has(s.id) && searchMatches.has(t.id))
        : true;

    if (isHighlighted) {
      ctx.globalAlpha = 0.55;
      const company = e.companies[0];
      ctx.strokeStyle = companyColors[company] || '#00e5ff';
      ctx.lineWidth = 0.5 + e.weight * 0.3;
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(t.x, t.y);
      ctx.stroke();
      ctx.globalAlpha = 0.04;
    } else {
      ctx.strokeStyle = '#1a2a3a';
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(t.x, t.y);
      ctx.stroke();
    }
  });

  // Draw hovered node edges (on top, bright)
  if (hoveredNode) {
    ctx.globalAlpha = 0.85;
    edges.forEach(e => {
      const s = e.source, t = e.target;
      if (!s.x || !t.x) return;
      if (s.id === hoveredNode.id || t.id === hoveredNode.id) {
        ctx.strokeStyle = companyColors[e.companies[0]] || '#00e5ff';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(s.x, s.y);
        ctx.lineTo(t.x, t.y);
        ctx.stroke();
      }
    });
  }

  // Draw nodes
  ctx.globalAlpha = 1;
  nodes.forEach(n => {
    if (!n.x) return;
    if (activeNodes && !activeNodes.has(n.id)) return;

    const r = 3 + Math.sqrt(n._degree || 0) * 2;
    const color = companyColors[n.companies[0]] || '#888';

    const isDimmed = (searchMatches && !searchMatches.has(n.id)) ||
                     (highlightedCompany && !n.companies.includes(highlightedCompany));
    const isHovered = hoveredNode && hoveredNode.id === n.id;

    ctx.globalAlpha = isDimmed ? 0.1 : (isHovered ? 1 : 0.85);

    // Node circle
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
    ctx.fillStyle = color + '33';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = isHovered ? 2.5 : 1.2;
    ctx.stroke();

    // Glow for hovered
    if (isHovered) {
      ctx.beginPath();
      ctx.arc(n.x, n.y, r + 4, 0, Math.PI * 2);
      ctx.strokeStyle = color + '55';
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    // Labels — show if hovered, searched, highlighted, or high-degree
    const showLabel = isHovered ||
      (searchMatches && searchMatches.has(n.id)) ||
      (highlightedCompany && n.companies.includes(highlightedCompany)) ||
      (transform.k > 2 && !isDimmed) ||
      (n._degree > 10 && !isDimmed);

    if (showLabel) {
      ctx.globalAlpha = isDimmed ? 0 : 1;
      ctx.font = `${Math.max(9, 10 / transform.k)}px DM Mono`;
      ctx.fillStyle = color;
      ctx.fillText(n.name.split(' ')[0], n.x + r + 3, n.y + 4);
    }
  });

  ctx.restore();
}

// ─── MOUSE INTERACTION ────────────────────────────────────────────────────────
function screenToGraph(sx, sy) {
  return {
    x: (sx - transform.x) / transform.k,
    y: (sy - transform.y) / transform.k
  };
}

function getNodeAt(sx, sy) {
  if (!graphData) return null;
  const gp = screenToGraph(sx, sy);
  let closest = null, closestDist = Infinity;
  const minDegFilter = minDegree > 1 ? new Set(graphData.nodes.filter(n => n._degree >= minDegree).map(n => n.id)) : null;
  graphData.nodes.forEach(n => {
    if (!n.x) return;
    if (minDegFilter && !minDegFilter.has(n.id)) return;
    const r = 3 + Math.sqrt(n._degree || 0) * 2;
    const dx = gp.x - n.x, dy = gp.y - n.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < r + 4 && dist < closestDist) {
      closestDist = dist;
      closest = n;
    }
  });
  return closest;
}

let dragNode = null;
function onMouseDown(e) {
  const node = getNodeAt(e.offsetX, e.offsetY);
  if (node) {
    dragNode = node;
    node.fx = node.x; node.fy = node.y;
    if (simulation) simulation.alphaTarget(0.1).restart();
  } else {
    isPanning = true;
    panStart = { x: e.offsetX - transform.x, y: e.offsetY - transform.y };
    canvas.classList.add('grabbing');
  }
}

function onMouseMove(e) {
  if (dragNode) {
    const gp = screenToGraph(e.offsetX, e.offsetY);
    dragNode.fx = gp.x; dragNode.fy = gp.y;
    return;
  }
  if (isPanning) {
    transform.x = e.offsetX - panStart.x;
    transform.y = e.offsetY - panStart.y;
    draw();
    return;
  }
  // Hover
  const node = getNodeAt(e.offsetX, e.offsetY);
  if (node !== hoveredNode) {
    hoveredNode = node;
    draw();
    const tip = document.getElementById('tooltip');
    if (node) {
      tip.textContent = node.name + (node.companies[0] ? ' · ' + node.companies[0] : '');
      tip.style.display = 'block';
      tip.style.left = (e.pageX + 14) + 'px';
      tip.style.top = (e.pageY - 10) + 'px';
    } else {
      tip.style.display = 'none';
    }
  } else if (node) {
    const tip = document.getElementById('tooltip');
    tip.style.left = (e.pageX + 14) + 'px';
    tip.style.top = (e.pageY - 10) + 'px';
  }
}

function onMouseUp(e) {
  if (dragNode) {
    dragNode.fx = null; dragNode.fy = null;
    dragNode = null;
    if (simulation) simulation.alphaTarget(0);
  }
  isPanning = false;
  canvas.classList.remove('grabbing');
}

function onCanvasClick(e) {
  const node = getNodeAt(e.offsetX, e.offsetY);
  if (node) showNodeInfo(node);
  else closeInfo();
}

function onWheel(e) {
  e.preventDefault();
  const scale = e.deltaY < 0 ? 1.12 : 0.88;
  const newK = Math.max(0.05, Math.min(12, transform.k * scale));
  // Zoom toward mouse position
  const mx = e.offsetX, my = e.offsetY;
  transform.x = mx - (mx - transform.x) * (newK / transform.k);
  transform.y = my - (my - transform.y) * (newK / transform.k);
  transform.k = newK;
  draw();
}

// ─── NODE INFO PANEL ─────────────────────────────────────────────────────────
function showNodeInfo(d) {
  document.getElementById('info-name').textContent = d.name;
  document.getElementById('info-role').textContent = d.companies[0] || '';
  document.getElementById('info-link').href = d.profileUrl || '#';

  const sharedWith = [];
  graphData.edges.forEach(e => {
    const s = e.source, t = e.target;
    const sid = typeof s === 'object' ? s.id : s;
    const tid = typeof t === 'object' ? t.id : t;
    if (sid === d.id || tid === d.id) {
      const otherId = sid === d.id ? tid : sid;
      const other = graphData.nodeMap[otherId];
      if (other) sharedWith.push(`<b>${other.name}</b> · ${e.companies.join(', ')}`);
    }
  });

  document.getElementById('info-companies').innerHTML =
    `<div style="margin-bottom:8px">Companies:<br>${d.companies.map(c => `<b style="color:${companyColors[c]||'#888'}">${c}</b>`).join(', ')}</div>` +
    `<div style="color:var(--text-dim)">Connections: <b style="color:var(--text)">${d._degree}</b></div>` +
    (sharedWith.length ? `<div style="margin-top:8px;color:var(--text-dim)">Shared employers:<br>${sharedWith.slice(0,6).join('<br>')}</div>` : '');

  document.getElementById('info-panel').classList.add('visible');
}

function closeInfo() { document.getElementById('info-panel').classList.remove('visible'); }

// ─── CONTROLS ────────────────────────────────────────────────────────────────
function updateForce(type, val) {
  if (!simulation) return;
  if (type === 'charge') { currentCharge = +val; simulation.force('charge').strength(+val); }
  if (type === 'distance') { currentDistance = +val; simulation.force('link').distance(+val); }
  if (type === 'strength') { currentStrength = +val; simulation.force('link').strength(+val); }
  simulation.alpha(0.2).restart();
}

function updateMinDegree(val) {
  minDegree = val;
  document.getElementById('val-mindeg').textContent = val;
  draw();
}

function toggleCompanyHighlight(company, el) {
  if (highlightedCompany === company) {
    highlightedCompany = null;
    document.querySelectorAll('.company-item').forEach(i => i.style.opacity = '1');
  } else {
    highlightedCompany = company;
    document.querySelectorAll('.company-item').forEach(i => {
      i.style.opacity = i.dataset.company === company ? '1' : '0.35';
    });
  }
  draw();
}

function searchGraph(query) {
  if (!graphData) return;
  if (!query) { searchMatches = null; draw(); return; }
  const q = query.toLowerCase();
  searchMatches = new Set();
  graphData.nodes.forEach(n => {
    if (n.name.toLowerCase().includes(q) || n.companies.some(c => c.toLowerCase().includes(q)))
      searchMatches.add(n.id);
  });
  draw();
}

// ─── FILE LOAD ────────────────────────────────────────────────────────────────
function loadFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      document.getElementById('mock-notice').style.display = 'none';
      companyColors = {};
      highlightedCompany = null;
      searchMatches = null;
      hoveredNode = null;
      if (simulation) { simulation.stop(); simulation = null; }
      init(data);
    } catch(err) {
      alert('Invalid JSON file.');
    }
  };
  reader.readAsText(file);
}

// ─── BOOT ─────────────────────────────────────────────────────────────────────
window.addEventListener('load', () => init(MOCK_DATA));
window.addEventListener('resize', () => {
  if (canvas) onResize();
});
</script>
</body>
</html>
